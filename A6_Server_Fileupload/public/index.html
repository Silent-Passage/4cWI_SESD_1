<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sicherer Datei-Upload</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">
          Sicherer Datei-Upload
        </h1>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
          Laden Sie Ihre Dateien sicher hoch. Unterst√ºtzte Formate: Bilder,
          PDFs, Textdateien (max. 10MB pro Datei)
        </p>
      </div>

      <!-- Upload Form -->
      <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8">
        <form id="uploadForm" enctype="multipart/form-data" class="space-y-6">
          <!-- File Input -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Dateien ausw√§hlen (max. 5 Dateien)
            </label>
            <input
              type="file"
              name="files"
              id="fileInput"
              multiple
              accept=".jpg,.jpeg,.png,.gif,.pdf,.txt,.doc,.docx"
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            />
            <p class="mt-1 text-sm text-gray-500">
              PNG, JPG, GIF, PDF, TXT, DOC bis 10MB
            </p>
          </div>

          <!-- Progress Bar -->
          <div id="progressContainer" class="hidden">
            <div class="flex justify-between text-sm text-gray-600 mb-1">
              <span>Upload Fortschritt</span>
              <span id="progressPercent">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div
                id="progressBar"
                class="bg-blue-600 h-2.5 rounded-full transition-all duration-300"
                style="width: 0%"
              ></div>
            </div>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            id="submitBtn"
            class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            Dateien hochladen
          </button>
        </form>

        <!-- Messages -->
        <div id="messageContainer" class="mt-6"></div>

        <!-- Uploaded Files -->
        <div id="uploadedFiles" class="mt-8 space-y-4"></div>
      </div>

      <!-- Security Info -->
      <div
        class="max-w-2xl mx-auto mt-8 bg-yellow-50 border border-yellow-200 rounded-lg p-6"
      >
        <h3 class="text-lg font-semibold text-yellow-800 mb-2">
          Sicherheitsma√ünahmen
        </h3>
        <ul class="text-sm text-yellow-700 space-y-1">
          <li>‚Ä¢ Dateityp-Validierung auf Server- und Client-Seite</li>
          <li>‚Ä¢ Maximale Dateigr√∂√üe: 10MB pro Datei</li>
          <li>‚Ä¢ Maximale Anzahl: 5 Dateien gleichzeitig</li>
          <li>‚Ä¢ Dateinamen-S√§uberung gegen Path Traversal</li>
          <li>‚Ä¢ Zeitstempel im Dateinamen zur Vermeidung von Konflikten</li>
          <li>
            ‚Ä¢ Uploads werden im Ordner
            <code class="bg-yellow-100 px-1 rounded">uploads/</code> gespeichert
          </li>
        </ul>
      </div>
    </div>

    <script>
      const form = document.getElementById("uploadForm");
      const fileInput = document.getElementById("fileInput");
      const submitBtn = document.getElementById("submitBtn");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const progressPercent = document.getElementById("progressPercent");
      const messageContainer = document.getElementById("messageContainer");
      const uploadedFiles = document.getElementById("uploadedFiles");

      // Client-seitige Validierung
      fileInput.addEventListener("change", function () {
        const files = this.files;
        let isValid = true;
        let errorMessage = "";

        // Anzahl der Dateien pr√ºfen
        if (files.length > 5) {
          isValid = false;
          errorMessage =
            "Maximal 5 Dateien k√∂nnen gleichzeitig hochgeladen werden.";
        }

        // Dateigr√∂√üe und Typ pr√ºfen
        for (let file of files) {
          if (file.size > 10 * 1024 * 1024) {
            isValid = false;
            errorMessage = `Datei "${file.name}" ist zu gro√ü. Maximal 10MB erlaubt.`;
            break;
          }

          const allowedTypes = [
            "image/jpeg",
            "image/png",
            "image/gif",
            "application/pdf",
            "text/plain",
            "application/msword",
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
          ];

          if (!allowedTypes.includes(file.type)) {
            isValid = false;
            errorMessage = `Dateityp von "${file.name}" wird nicht unterst√ºtzt.`;
            break;
          }
        }

        submitBtn.disabled = !isValid;
        showMessage(errorMessage, "error");
      });

      // Form Submit Handler
      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const files = fileInput.files;
        if (files.length === 0) {
          showMessage("Bitte w√§hlen Sie mindestens eine Datei aus.", "error");
          return;
        }

        const formData = new FormData();
        for (let file of files) {
          formData.append("files", file);
        }

        // UI zur√ºcksetzen
        submitBtn.disabled = true;
        progressContainer.classList.remove("hidden");
        progressBar.style.width = "0%";
        progressPercent.textContent = "0%";
        messageContainer.innerHTML = "";

        try {
          const xhr = new XMLHttpRequest();

          xhr.upload.addEventListener("progress", function (e) {
            if (e.lengthComputable) {
              const percentComplete = (e.loaded / e.total) * 100;
              progressBar.style.width = percentComplete + "%";
              progressPercent.textContent = Math.round(percentComplete) + "%";
            }
          });

          xhr.addEventListener("load", function () {
            try {
              const response = JSON.parse(xhr.responseText);

              if (response.success) {
                showMessage(response.message, "success");
                displayUploadedFiles(response.files);
                form.reset();
                submitBtn.disabled = false;
              } else {
                showMessage(response.message, "error");
                submitBtn.disabled = false;
              }
            } catch (parseError) {
              showMessage(
                "Fehler beim Verarbeiten der Server-Antwort",
                "error"
              );
              submitBtn.disabled = false;
            }
            progressContainer.classList.add("hidden");
          });

          xhr.addEventListener("error", function () {
            showMessage("Netzwerkfehler beim Hochladen", "error");
            progressContainer.classList.add("hidden");
            submitBtn.disabled = false;
          });

          xhr.open("POST", "/upload");
          xhr.send(formData);
        } catch (error) {
          showMessage("Fehler beim Hochladen: " + error.message, "error");
          progressContainer.classList.add("hidden");
          submitBtn.disabled = false;
        }
      });

      // Hilfsfunktionen
      function showMessage(message, type) {
        if (!message) return;

        const bgColor =
          type === "error"
            ? "bg-red-50 border-red-200 text-red-800"
            : type === "success"
            ? "bg-green-50 border-green-200 text-green-800"
            : "bg-blue-50 border-blue-200 text-blue-800";

        messageContainer.innerHTML = `
                <div class="p-4 border rounded-lg ${bgColor}">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            ${
                              type === "error"
                                ? "‚ùå"
                                : type === "success"
                                ? "‚úÖ"
                                : "‚ÑπÔ∏è"
                            }
                        </div>
                        <div class="ml-3">
                            <p class="text-sm">${message}</p>
                        </div>
                    </div>
                </div>
            `;
      }

      function displayUploadedFiles(files) {
        if (!files || files.length === 0) return;

        let html =
          '<h3 class="text-lg font-semibold text-gray-800 mb-4">Hochgeladene Dateien:</h3>';

        files.forEach((file) => {
          const size = (file.size / 1024 / 1024).toFixed(2);
          html += `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <span class="text-blue-600 font-semibold">${getFileIcon(
                                  file.mimetype
                                )}</span>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">${
                                  file.originalName
                                }</p>
                                <p class="text-sm text-gray-500">${
                                  file.mimetype
                                } ‚Ä¢ ${size} MB</p>
                                <p class="text-xs text-gray-400">Gespeichert als: ${
                                  file.savedName
                                }</p>
                            </div>
                        </div>
                        <span class="text-green-600 text-sm font-medium">‚úì Erfolgreich</span>
                    </div>
                `;
        });

        uploadedFiles.innerHTML = html;
      }

      function getFileIcon(mimetype) {
        if (mimetype.startsWith("image/")) return "üñºÔ∏è";
        if (mimetype === "application/pdf") return "üìÑ";
        if (mimetype.startsWith("text/")) return "üìù";
        return "üìé";
      }
    </script>
  </body>
</html>
